name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      run_devnet_smoke:
        description: "Run devnet smoke test"
        type: boolean
        default: false

env:
  SOLANA_VERSION: "2.1.14"
  ANCHOR_VERSION: "0.32.1"
  NODE_VERSION: "20"
  RUST_TOOLCHAIN: "1.83.0"

jobs:
  checks:
    name: Lint & Safety Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}
          components: rustfmt, clippy

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-

      - name: cargo fmt
        run: cargo fmt --all -- --check

      - name: cargo clippy
        run: cargo clippy --workspace --all-targets -- -D warnings

      - name: No test-only features
        run: bash scripts/check-no-test-features.sh

      - name: Program ID drift check
        run: bash scripts/check-program-id-drift.sh

  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    needs: checks
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-

      - name: Install Solana
        uses: solana-foundation/solana-install@v0.1
        with:
          version: ${{ env.SOLANA_VERSION }}

      - name: Install Anchor CLI
        run: |
          cargo install --git https://github.com/coral-xyz/anchor --tag v${{ env.ANCHOR_VERSION }} anchor-cli --locked --force

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install npm deps
        run: npm ci

      - name: Generate keypair
        run: solana-keygen new --no-bip39-passphrase -s

      - name: Anchor build
        run: anchor build

      - name: Anchor test (localnet)
        run: anchor test --skip-build -- --timeout 120000

  devnet-smoke:
    name: Devnet Smoke (Ed25519)
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && inputs.run_devnet_smoke
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}

      - name: Install Solana
        uses: solana-foundation/solana-install@v0.1
        with:
          version: ${{ env.SOLANA_VERSION }}

      - name: Install Anchor CLI
        run: |
          cargo install --git https://github.com/coral-xyz/anchor --tag v${{ env.ANCHOR_VERSION }} anchor-cli --locked --force

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install npm deps
        run: npm ci

      - name: Import devnet wallet
        run: echo "${{ secrets.DEVNET_KEYPAIR }}" > ~/.config/solana/id.json

      - name: Run devnet smoke
        run: |
          solana config set --url devnet
          npx ts-mocha -p tsconfig.json -t 120000 tests/devnet-smoke-ed25519.ts
        env:
          ANCHOR_PROVIDER_URL: https://api.devnet.solana.com
